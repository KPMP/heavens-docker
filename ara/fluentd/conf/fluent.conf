<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

<filter orion-data>
    @type parser
    key_name log
    reserve_data true
    reserve_time true
    <parse>
      @type grok
      grok_failure_key grokfailure
      <grok>
        pattern %{TIMESTAMP_ISO8601:time_stamp}%{SPACE}%{LOGLEVEL:log_level}%{SPACE}%{NUMBER:pid}%{SPACE}---%{SPACE}\[\s*%{DATA:threadname}\]%{SPACE}%{DATA:logger}%{SPACE}:%{SPACE}USER\:%{SPACE}userId\:%{SPACE}(?<userID>.*),%{SPACE}firstName\:%{SPACE}(?<firstName>.*),%{SPACE}lastName\:%{SPACE}(?<lastName>.*),%{SPACE}displayName\:%{SPACE}(?<displayName>.*),%{SPACE}email\:%{SPACE}(?<email>.*),%{SPACE}shibId\:%{SPACE}(?<shibId>.*)%{SPACE}\|%{SPACE}PKGID\:%{SPACE}(?<pkgid>.*)%{SPACE}\|%{SPACE}URI\:%{SPACE}(?<uri>.*)%{SPACE}\|%{SPACE}MSG\:%{SPACE}(?<appMessage>.*) 
      </grok>
      <grok>
        pattern %{TIMESTAMP_ISO8601:time_stamp}%{SPACE}%{LOGLEVEL:log_level}%{SPACE}%{NUMBER:pid}%{SPACE}---%{SPACE}\[\s*%{DATA:threadname}\]%{SPACE}%{DATA:logger}%{SPACE}:%{SPACE}(?<message>(.|\r|\n)*)
      </grok>
    </parse>
</filter>

<filter eridanus-data>
    @type parser
    key_name log
    reserve_data true
    reserve_time true
    <parse>
      @type grok
      grok_failure_key grokfailure
      <grok>
        pattern %{TIMESTAMP_ISO8601:time_stamp}%{SPACE}%{LOGLEVEL:log_level}%{SPACE}%{NUMBER:pid}%{SPACE}---%{SPACE}\[\s*%{DATA:threadname}\]%{SPACE}%{DATA:logger}%{SPACE}:%{SPACE}URI\:%{SPACE}(?<uri>.*)%{SPACE}\|%{SPACE}MSG\:%{SPACE}(?<appMessage>.*) 
      </grok>
      <grok>
        pattern %{TIMESTAMP_ISO8601:time_stamp}%{SPACE}%{LOGLEVEL:log_level}%{SPACE}%{NUMBER:pid}%{SPACE}---%{SPACE}\[\s*%{DATA:threadname}\]%{SPACE}%{DATA:logger}%{SPACE}:%{SPACE}(?<message>(.|\r|\n)*)
      </grok>
    </parse>
</filter>

<filter state-manager-data>
    @type parser
    key_name log
    reserve_data true
    reserve_time true
    <parse>
      @type grok
      grok_failure_key grokfailure
      <grok>
        pattern %{TIMESTAMP_ISO8601:time_stamp}%{SPACE}%{LOGLEVEL:log_level}%{SPACE}%{NUMBER:pid}%{SPACE}---%{SPACE}\[\s*%{DATA:threadname}\]%{SPACE}%{DATA:logger}%{SPACE}:%{SPACE}URI\:%{SPACE}(?<uri>.*)%{SPACE}\|%{SPACE}PKGID\:%{SPACE}(?<pkgid>.*)%{SPACE}\|%{SPACE}MSG\:%{SPACE}(?<appMessage>.*) 
      </grok>
      <grok>
        pattern %{TIMESTAMP_ISO8601:time_stamp}%{SPACE}%{LOGLEVEL:log_level}%{SPACE}%{NUMBER:pid}%{SPACE}---%{SPACE}\[\s*%{DATA:threadname}\]%{SPACE}%{DATA:logger}%{SPACE}:%{SPACE}URI\:%{SPACE}(?<uri>.*)%{SPACE}\|%{SPACE}MSG\:%{SPACE}(?<appMessage>.*) 
      </grok>
      <grok>
        pattern %{TIMESTAMP_ISO8601:time_stamp}%{SPACE}%{LOGLEVEL:log_level}%{SPACE}%{NUMBER:pid}%{SPACE}---%{SPACE}\[\s*%{DATA:threadname}\]%{SPACE}%{DATA:logger}%{SPACE}:%{SPACE}(?<message>(.|\r|\n)*)
      </grok>
    </parse>
</filter>

<filter delphinus-data>
    @type parser
    key_name log
    reserve_data true
    reserve_time true
    <parse>
      @type grok
      grok_failure_key grokfailure
      <grok>
        pattern %{TIMESTAMP_ISO8601:time_stamp}%{SPACE}%{LOGLEVEL:log_level}%{SPACE}%{NUMBER:pid}%{SPACE}---%{SPACE}\[\s*%{DATA:threadname}\]%{SPACE}%{DATA:logger}%{SPACE}:%{SPACE}USER\:%{SPACE}firstName\:%{SPACE}(?<firstName>.*),%{SPACE}lastName\:%{SPACE}(?<lastName>.*),%{SPACE}displayName\:%{SPACE}(?<displayName>.*),%{SPACE}email\:%{SPACE}(?<email>.*),%{SPACE}shibId\:%{SPACE}(?<shibId>.*)%{SPACE}\|%{SPACE}URI\:%{SPACE}(?<uri>.*)%{SPACE}\|%{SPACE}MSG\:%{SPACE}(?<appMessage>.*) 
      </grok>
      <grok>
        pattern %{TIMESTAMP_ISO8601:time_stamp}%{SPACE}%{LOGLEVEL:log_level}%{SPACE}%{NUMBER:pid}%{SPACE}---%{SPACE}\[\s*%{DATA:threadname}\]%{SPACE}%{DATA:logger}%{SPACE}:%{SPACE}(?<message>(.|\r|\n)*)
      </grok>	  
    </parse>
</filter>

<match orion-data>
  @type grepcounter
  count_interval 3                  # time window for counting errors in seconds
  input_key log_level               # field to apply the regex
  regexp ^ERROR$
  threshold 1                       # minimum number of errors to trigger an alert
  add_tag_prefix error_tomcat       # generate tags like error_tomcat.orion-data
</match>

<match error_tomcat.orion-data>
  @type copy
  <store>
    @type stdout
  </store>
  <store>
    @type mail
    host smtp.gmail.com
    port 587
    user kpmpNotifications@gmail.com
    password lcbzgrkijgtmaiqn
    enable_starttls_auto true
    from kpmpNotifications@gmail.com
    to kingstonduo@gmail.com
    subject 'DLU Tomcat Error'
    message %s ERRORs in Tomcat
    message_out_keys count
  </store>
</match>
